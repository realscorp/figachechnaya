# Фигачечная
https://figachechnaya.ru

<details>
  <summary>Сайт</summary>
  ![скриншот](https://figachechnaya.hb.bizmrg.com/front.gif)
</details>

https://grafana.figachechnaya.ru - метрики и логи *(user:o66Vsxt7PZbpQC_PYvWL59rNBkRcWMPA)*

<details>
  <summary>Мониторинг</summary>
  Под нагрузочным тестированием через Jmeter
  ![скриншот](https://figachechnaya.hb.bizmrg.com/grafana2.png)
  ![скриншот](https://figachechnaya.hb.bizmrg.com/grafana3.png)
</details>

Репозиторий автоматически зеркалируется https://gitlab.com/realscorp/figachechnaya -> https://github.com/realscorp/figachechnaya  
  
Автоматизация построена через Gitlab CI
## Что это и зачем
**Фигачечная** - простой сервис по офигачиванию слов (*Велосипед -> Фигасипед*).  
Для меня это тренировка, чтобы обновить, закрепить и показать навыки:
- Python (REST API, Metrics, Logging)
- Docker
- Kubernetes
- Gitlab CI
- Observability (Prometheus/Loki/Grafana)  

А ещё это способ показать понимание принципов построения микросервисного приложения и просто повод немного повеселиться :)
# Техническое задание
Компания-стартап "Фигант Кузбасса" уверена в том, что новый сервис "Фигачечная" выстрелит на рынке и готова сразу строить приложение по микросервисной архитектуре, чтобы упростить его дальнейшее развитие и масштабирование.
### Product owner хочет следующую функциональность
- Сайт позволяет пользователю ввести слово или фразу на русском языке и, нажав кнопку, сразу получить офигализированный вариант
- Сайт позволяет выбрать схему преобразования слова
- В подсказке под полем ввода показывается предыдущий выполненный запрос к сервису от любого пользователя, который постоянно обновляется: это даёт пользователю "чувство локтя"
- В футере страницы показывается автоматически обновляемая статистика: количество запросов к сервису. Это демонстрирует пользователю популярность сервиса.
- Сервис доступен по https с валидным сертификатом для SEO-оптимизации
### Разработка предлагает
- Сервис разделяется на простой фронтенд (HTML+CSS+JavaScript) и бэкенд, состоящий из двух RESTful-микросервисов: микросервис Figalize (преобразование слова, список схем преобразования) и микросервис History (добавление запроса к истории, предоставление списка выполненных запросов)
- Разработка ведётся на Python + FastAPI
- Для хранения истории используется БД PostgreSQL
### Эксплуатация предлагает
- Использовать инструменты observability
- Получать из микросервисов метрики производительности приложения
- Получать из микросервисов логи
- Graceful degradation для микросервисов
- Запуск в Kubernetes
- Запуск в облаке
- Использовать подход Infrastructure as Code
- Для ускорения запуска будет использоваться DBaaS в облаке
- Для упрощения и ускорения разработки, тестирования и деплоя необходимо построить автоматизированный пайплайн
- Использовать паттерны [12 Factor App](https://12factor.net/)
## Архитектура
                 https://figachechnaya.ru
                            │
                            │HTTPS (LE cert)
                            │
                    ┌───────▼───────┐
                    │ INGRESS NGINX │
                    └───────┬───────┘
                            │
                            │HTTP
                            │
         get history ┌──────▼─────┐ figalize request
           ┌─────────┤  FRONTEND  ├───────────┐
           │         └────────────┘ get schema│
           │                                  │
           │                                  │
    ┌──────▼────────┐                ┌────────▼─────┐
    │    HISTORY    │   add history  │   FIGALIZE   │
    │  microservice │◄───────────────┤ microservice │
    └──────┬────────┘                └──────────────┘
           │
           │
           │           ┌──────────┐
           │           │          │
           │STORE      │          │
           └──────────►│POSTGRESQL│
            QUERY      │          │
                       │          │
                       └──────────┘
## API
API доступен из интернета, и автоматически построенную OpenAPI-документацию можно посмотреть здесь:
- Figalize: https://figachechnaya.ru/api/figalize/docs
- History: https://figachechnaya.ru/api/history/docs
## Сделано
- Написан простой фронтенд на HTML+CSS+JS
- Написаны RESTful stateless-микросервисы на Python + FastAPI с хранением данных в БД PostgreSQL
- Микросервисы экспортируют метрики в Prometheus-формате
- Микросервисы умеют в асинхронное выполнение запросов
- Сервисы частично умеют в graceful degradation
- Написан инфраструктурный Terraform-код (облачные сетевые объекты, DBaaS, K8s-кластер, деплой приложений и helm-чартов в K8s)
- Написан Gitlab-CI пайплайн для разворачивания всего сервиса из кода (Validate -> Build -> Deploy)
- Сервисы получают сертификаты через cert-manager
- В кластер деплоится Prometheus-stack для сбора метрик и визуализации
- Prometheus настроен из кода на service discovery и скрейп метрик из приложений
- В Grafana настроены 4 golden signal по метрикам из ингресса приложения и ещё пара дашбордов
## Todo
- Общий формат логирования
- Сбор логов в Loki
- **Многочисленные** доработки мониторинга
  - Собрать метрики из DBaaS
  - Провижининг Grafana
  - Доработка дашбордов
- Более правильный пайп деплоя приложения с автосозданием тегов образов
- Упаковка приложения в Helm-чарт
- Управление резервными копиями БД
- Линтинг для Python на шаге Validate
- Добавить шаг с юнит-тестами для Python
- Добавить шаг с SAST-тестами
- Автоматическое управление релизами

## Не сделано и в планах нет
- Доработка фронтенда и линтер HTML+CSS+JS на шаге Validate: слишком нерелевантный навык для меня
- Автотесты HTML+CSS+JS
- Отдельные окружения для DEV/QA/Stage: слишком дорогая аренда ресурсов
## Автор всего кода
Сергей Краснов, realscorp@outlook.com